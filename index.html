<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Folder Slideshow (224×224 resized)</title>
  <style>
    :root{
      --bg: #0b0f14; --fg: #e9eef5; --muted: #9aa7b1; --accent: #5b9dff; --accent-2: #00d4ff; --card: #121922;
    }
    html, body { height: 100%; }
    body{ margin:0; background: radial-gradient(1200px 800px at 75% 10%, #0f1621 0%, #0b0f14 50%, #090c10 100%); color: var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow:hidden; }
    .shell{position:relative; height:100%; width:100%; display:grid; grid-template-rows:auto 1fr auto;}

    .topbar{ display:flex; align-items:center; gap:.75rem; padding: .75rem 1rem; background: rgba(15, 22, 33, .6); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(255,255,255,.06); }
    .title{font-weight:700; letter-spacing:.2px;}
    .spacer{flex:1}
    .hint{color:var(--muted); font-size:.9rem}

    .stage{ position:relative; height:100%; display:grid; place-items:center; }
    .img-wrap{ position:relative; height:100%; width:100%; display:grid; place-items:center;}
    /* Note: images shown are the already-resized 224×224 versions, scaled up to fit */
    .img{ max-height: 100%; max-width: 100%; object-fit: contain; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.5); transition: opacity .35s ease, transform .4s ease; opacity:0; transform: scale(.985); image-rendering:auto; }
    .img.show{ opacity:1; transform: scale(1); }

    .controls{ position:absolute; inset:auto 0 1.25rem 0; display:flex; align-items:center; gap:.75rem; justify-content:center; }
    .panel{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; border-radius: 999px; background: linear-gradient(180deg, rgba(24,33,48,.85), rgba(14,20,30,.85)); border: 1px solid rgba(255,255,255,.08); box-shadow: 0 6px 24px rgba(0,0,0,.35); }
    .btn{appearance:none; border:0; border-radius:999px; padding:.55rem .8rem; background: #162234; color:var(--fg); display:inline-flex; align-items:center; gap:.5rem; cursor:pointer; font: inherit; font-weight:600; letter-spacing:.2px; transition: transform .04s ease, background .2s ease, opacity .2s ease;}
    .btn:hover{ background:#1e2c44 }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .icon{ width:18px; height:18px; display:inline-block }

    .slider{ -webkit-appearance:none; appearance:none; width:160px; height:6px; border-radius:999px; background:#1b2940; outline:none; }
    .slider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border:none; box-shadow: 0 2px 10px rgba(0,0,0,.4)}
    .slider::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border:none; box-shadow: 0 2px 10px rgba(0,0,0,.4) }

    .bottombar{ display:flex; align-items:center; gap:1rem; padding:.6rem .9rem; background: rgba(15, 22, 33, .6); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,.06); }
    .progress{ position:relative; height:8px; flex:1; background:#101724; border-radius:999px; overflow:hidden; }
    .progress > span{ position:absolute; inset:0 auto 0 0; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    .drawer{ position:absolute; left:0; right:0; bottom:0; transform: translateY(100%); transition: transform .35s ease; background: rgba(12,18,28,.96); border-top: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px); max-height: 40vh; overflow:auto;}
    .drawer.open{ transform: translateY(0); }
    .thumbs{ display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:.5rem; padding: .75rem; }
    .thumb{ width:100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; cursor:pointer; border:2px solid transparent; transition: border-color .2s ease, transform .15s ease; }
    .thumb:hover{ transform: translateY(-2px) }
    .thumb.active{ border-color: var(--accent); }

    .mode{ display:flex; align-items:center; gap:.5rem; color:var(--muted); }
    .mode label{ display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; }
    .radio{ accent-color: #5b9dff; }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <strong class="title">PaS-F Random Image Examples</strong>
      <div class="spacer"></div>
      <div class="mode" title="How to resize into a square">
        <label><input type="radio" name="mode" id="mode-cover" class="radio" checked> Cover (crop)</label>
        <label><input type="radio" name="mode" id="mode-contain" class="radio"> Contain (pad)</label>
      </div>
      <button id="rebuild" class="btn" title="Rebuild resized images">Rebuild</button>
    </header>

    <main class="stage">
      <div class="img-wrap">
        <img id="viewer" class="img" alt="Slideshow image" />
      </div>
      <div class="controls">
        <div class="panel">
          <button id="prev" class="btn" title="Previous (←)">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <button id="play" class="btn" title="Play/Pause (Space)">
            <svg id="play-icon" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pause-icon" class="icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
          </button>
          <button id="next" class="btn" title="Next (→)">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
          </button>
          <input id="speed" class="slider" type="range" min="1500" max="10000" value="3500" step="100" title="Autoplay interval (ms)" />
          <button id="thumbs-toggle" class="btn" title="Toggle thumbnails (T)">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h7v7H4V4zm9 0h7v7h-7V4zM4 13h7v7H4v-7zm9 0h7v7h-7v-7z"/></svg>
            <span>Thumbnails</span>
          </button>
          <button id="full" class="btn" title="Fullscreen (F)">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm12 0h-2v3h-3v2h5v-5zM7 7h3V5H5v5h2V7zm10 3h2V5h-5v2h3v3z"/></svg>
          </button>
        </div>
      </div>

      <aside id="drawer" class="drawer">
        <div id="thumbs" class="thumbs"></div>
      </aside>
    </main>

    <footer class="bottombar">
      <div id="status" class="hint">Preparing…</div>
      <div class="progress"><span id="bar"></span></div>
    </footer>
  </div>

  <script>
    // === Configuration ===
    const ROOT = './photos/';                 // hardcoded folder on your server
    const MANIFEST = ROOT + 'manifest.json';  // list of image paths relative to ROOT
    const SIZE = 224;                         // target size (square)

    const viewer = document.getElementById('viewer');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const playBtn = document.getElementById('play');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const speed = document.getElementById('speed');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const thumbsWrap = document.getElementById('thumbs');
    const drawer = document.getElementById('drawer');
    const thumbsToggle = document.getElementById('thumbs-toggle');
    const fullBtn = document.getElementById('full');
    const rebuildBtn = document.getElementById('rebuild');
    const modeCover = document.getElementById('mode-cover');
    const modeContain = document.getElementById('mode-contain');

    let files = []; // {name, url} — url points to resized 224×224 blob
    let originals = []; // original paths from manifest (for rebuilds)
    let index = 0; let timer = null;

    async function loadManifest(){
      const res = await fetch(MANIFEST, {cache:'no-cache'});
      if(!res.ok) throw new Error('Missing manifest.json in ./photos');
      const list = await res.json();
      if(!Array.isArray(list) || !list.length) throw new Error('manifest.json is empty or invalid');
      originals = list; // keep originals
    }

    function drawResized(img, size, mode){
      const c = document.createElement('canvas');
      c.width = size; c.height = size;
      const ctx = c.getContext('2d');
      // background padding color when using contain
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,size,size);
      const iw = img.naturalWidth || img.width; const ih = img.naturalHeight || img.height;
      let scale, w, h, dx, dy;
      if(mode === 'cover'){
        scale = Math.max(size / iw, size / ih);
      } else {
        scale = Math.min(size / iw, size / ih);
      }
      w = Math.round(iw * scale); h = Math.round(ih * scale);
      dx = Math.round((size - w) / 2); dy = Math.round((size - h) / 2);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, dx, dy, w, h);
      return c;
    }

    function resizeURLToBlobURL(url, size, mode){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{
          try{
            const canvas = drawResized(img, size, mode);
            canvas.toBlob(b=>{
              if(!b) return reject(new Error('Failed to create blob'));
              resolve(URL.createObjectURL(b));
            }, 'image/jpeg', 0.9);
          }catch(e){ reject(e); }
        };
        img.onerror = ()=> reject(new Error('Failed to load '+url));
        img.decoding = 'async';
        img.src = url;
      });
    }

    async function buildResized(){
      files.forEach(f=>{ if(f._tmp){ URL.revokeObjectURL(f.url); } });
      files = [];
      const mode = modeCover.checked ? 'cover' : 'contain';
      statusEl.textContent = `Resizing ${originals.length} images to ${SIZE}×${SIZE} (${mode})…`;
      let done = 0;
      const concurrency = 4; // limit parallel work
      const queue = [...originals];
      const workers = new Array(concurrency).fill(0).map(async ()=>{
        while(queue.length){
          const name = queue.shift();
          const url = ROOT + name;
          try{
            const blobUrl = await resizeURLToBlobURL(url, SIZE, mode);
            files.push({ name, url: blobUrl, _tmp: true });
          }catch(e){ console.warn(e); }
          done++;
          statusEl.textContent = `Resized ${done}/${originals.length}`;
          bar.style.width = `${(done/originals.length)*100}%`;
        }
      });
      await Promise.all(workers);
      files.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
      bar.style.width = '0%';
      if(files.length){ buildThumbs(); show(0); statusEl.textContent = `${files.length} images ready (224×224)`; }
      else { statusEl.textContent = 'No images resized.'; }
    }

    function buildThumbs(){
      thumbsWrap.innerHTML = '';
      files.forEach((f,i)=>{
        const img = document.createElement('img');
        img.src = f.url; img.className = 'thumb'; img.title = f.name; img.loading = 'lazy';
        img.addEventListener('click', ()=> { show(i); });
        thumbsWrap.appendChild(img);
      });
      markActiveThumb();
    }

    function markActiveThumb(){
      Array.from(thumbsWrap.children).forEach((el,i)=>{ el.classList.toggle('active', i === index); });
    }

    function show(i){
      if(!files.length) return;
      index = (i + files.length) % files.length;
      const current = files[index];
      viewer.classList.remove('show');
      setTimeout(()=>{
        viewer.src = current.url;
        viewer.onload = ()=> viewer.classList.add('show');
      }, 40);
      statusEl.textContent = `${index+1} / ${files.length} — ${current.name} (224×224)`;
      markActiveThumb();
      const next = new Image(); next.src = files[(index+1)%files.length].url;
    }

    function next(){ show(index+1); }
    function prev(){ show(index-1); }

    function play(){ if(timer) return; tick(); updatePlayState(); }
    function stop(){ if(timer){ clearTimeout(timer); timer = null; } updatePlayState(); }
    function tick(){ timer = setTimeout(()=>{ next(); tick(); }, Number(speed.value)); }

    function updatePlayState(){
      const playing = !!timer;
      playIcon.classList.toggle('hidden', playing);
      pauseIcon.classList.toggle('hidden', !playing);
      playBtn.title = playing ? 'Pause (Space)' : 'Play (Space)';
    }

    function toggleDrawer(){ drawer.classList.toggle('open'); }

    // Wire up UI
    prevBtn.addEventListener('click', prev);
    nextBtn.addEventListener('click', next);
    playBtn.addEventListener('click', ()=> timer?stop():play());
    speed.addEventListener('input', ()=>{ if(timer){ clearTimeout(timer); tick(); } });
    thumbsToggle.addEventListener('click', toggleDrawer);
    fullBtn.addEventListener('click', ()=>{
      const el = document.documentElement;
      if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    });
    rebuildBtn.addEventListener('click', buildResized);

    // Keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight'){ next(); }
      else if(e.key === 'ArrowLeft'){ prev(); }
      else if(e.code === 'Space'){ e.preventDefault(); timer?stop():play(); }
      else if(e.key === 'f' || e.key === 'F'){ fullBtn.click(); }
      else if(e.key === 't' || e.key === 'T'){ toggleDrawer(); }
      else if(e.key === 'r' || e.key === 'R'){ buildResized(); }
    });

    // Start
    (async()=>{
      try{
        await loadManifest();
        await buildResized();
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Error: ' + err.message;
      }
    })();
  </script>
</body>
</html>
